language: node_js
node_js: 8
env: 
  - $NODE_VERSION="8.7"
matrix:
  include:
    # Unit Tests
    - install:
      - yarn install
      script:
      - yarn test
      after_script:
      - 'cat coverage/lcov.info | ./node_modules/.bin/coveralls'

    # E2E Web
    - install:
      - cd example/react-example
      - yarn install
      before_script:
      - yarn run build
      script:
      - yarn test

    # E2E XCode 9
    - language: objective-c
      os: osx
      osx_image: xcode9
      cache: yarn
      before_install:
      - brew tap wix/brew
      - brew install applesimutils --HEAD
      - nvm install $NODE_VERSION;
      - nvm use --delete-prefix $NODE_VERSION;
      - curl -o- -L https://yarnpkg.com/install.sh | bash -s
      - export PATH="$HOME/.yarn/bin:$PATH"
      - yarn global add react-native-cli detox-cli >/dev/null 2>&1
      install:
      - cd example/react-native-example
      - yarn
      script:
      - yarn run test:ios

    # E2E Tests android
    - language: android
      os: linux
      jdk: oraclejdk8
      env:
        - NODE_VERSION=8.7
        - ANDROID_API=25
        - EMULATOR_API=26
        - ANDROID_BUILD_TOOLS=25.0.2
        - ADB_INSTALL_TIMEOUT=5 # minutes
      android:
        components:
          - tools
          - platform-tools
          - build-tools-$ANDROID_BUILD_TOOLS
          - android-$ANDROID_API
          - android-$EMULATOR_API_LEVEL
          - extra-google-m2repository
          - extra-android-m2repository # for design library
          - addon-google_apis-google-25 # google play services
          - sys-img-armeabi-v7a-addon-google_apis-google-$ANDROID_API_LEVEL
          - sys-img-armeabi-v7a-android-$EMULATOR_API_LEVEL # the fix!
      before_install:
      - nvm install $NODE_VERSION;
      - nvm use --delete-prefix $NODE_VERSION;
      - curl -o- -L https://yarnpkg.com/install.sh | bash -s
      - export PATH="$HOME/.yarn/bin:$PATH"

      - echo "y" | android update sdk -a --no-ui --filter android-26
      - echo "y" | android update sdk -a --no-ui --filter sys-img-armeabi-v7a-android-26
      - android list targets | grep -E '^id:' | awk -F '"' '{$1=""; print $2}' # list all targets
      - echo no | android create avd --force -n Nexus_5X_API_26 -t android-26 --abi armeabi-v7a
      - emulator -avd Nexus_5X_API_26 -no-skin -no-window &
      install:
      - cd example/react-native-example
      - yarn
      script:
      - android-wait-for-emulator
      - adb shell input keyevent 82 &
      - yarn run test:android
